From 423fac5606d039b3729109fdf1029c43dd15604d Mon Sep 17 00:00:00 2001
From: Vincent Chen <vincent.chen@sifive.com>
Date: Fri, 8 Oct 2021 11:45:30 +0000
Subject: [PATCH 3/9] riscv: SiFive Unmatched set LED to purple

Original patch:
https://github.com/sifive/meta-sifive/blob/2021.09/recipes-bsp/u-boot/files/riscv64/0011-board-sifive-Set-LED-s-color-to-purple-in-the-U-boot.patch

Signed-off-by: David Abdurachmanov <david.abdurachmanov@gmail.com>
---
 board/sifive/unmatched/unmatched.c | 14 ++++++++++++++
 configs/sifive_unmatched_defconfig |  1 +
 2 files changed, 15 insertions(+)

diff --git a/board/sifive/unmatched/unmatched.c b/board/sifive/unmatched/unmatched.c
index 7983f781..da306975 100644
--- a/board/sifive/unmatched/unmatched.c
+++ b/board/sifive/unmatched/unmatched.c
@@ -39,6 +39,7 @@ void pwm_device_init(void)
 	struct pwm_sifive_regs *pwm0, *pwm1;
 	pwm0 = (struct pwm_sifive_regs *)PWM0_BASE;
 	pwm1 = (struct pwm_sifive_regs *)PWM1_BASE;
+#ifdef CONFIG_SPL_BUILD
 	writel(PWM_CMP_DISABLE_VAL, (void *)&pwm0->cmp0);
 	/* Set the 3-color PWM LEDs to yellow in SPL */
 	writel(PWM_CMP_ENABLE_VAL, (void *)&pwm0->cmp1);
@@ -57,6 +58,19 @@ void pwm_device_init(void)
 	writel(PWM_CMP_ENABLE_VAL, (void *)&pwm1->cmp2);
 	writel(PWM_CMP_ENABLE_VAL, (void *)&pwm1->cmp3);
 	writel(PWM_CFG_INIT, (void *)&pwm1->cfg);
+#else
+	/* Set the 3-color PWM LEDs to purple in U-boot */
+	writel(PWM_CMP_DISABLE_VAL, (void *)&pwm0->cmp1);
+	writel(PWM_CMP_ENABLE_VAL, (void *)&pwm0->cmp2);
+	writel(PWM_CMP_ENABLE_VAL, (void *)&pwm0->cmp3);
+#endif
+
+}
+
+int board_early_init_f(void)
+{
+	pwm_device_init();
+	return 0;
 }
 
 void *board_fdt_blob_setup(void)
diff --git a/configs/sifive_unmatched_defconfig b/configs/sifive_unmatched_defconfig
index 1dde98e0..ddc3c60e 100644
--- a/configs/sifive_unmatched_defconfig
+++ b/configs/sifive_unmatched_defconfig
@@ -42,3 +42,4 @@ CONFIG_DM_SCSI=y
 CONFIG_USB=y
 CONFIG_USB_XHCI_HCD=y
 CONFIG_USB_XHCI_PCI=y
+CONFIG_BOARD_EARLY_INIT_F=y
-- 
2.32.0

